<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Tony Boyles <nsp3@cdc.gov>">
    <title>CSV2FASTA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="custom.css" rel="stylesheet" />
  </head>

  <body>
    <div class="container" style="max-width: 540px;">
      <main role="main" class="col">
        <div class="text-center mt-3 mb-3">
          <h1 class="h1">CSV2FASTA</h1>
        </div>
        <div class="form-group">
          <div class="mb-2">CSV File</div>
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="customFile">
            <label class="custom-file-label" for="customFile">Choose file</label>
          </div>
        </div>
        <div class="row">
          <div class="form-group col">
            <label for="idCol">ID Column</label>
            <select class="form-control" id="idCol" disabled></select>
          </div>
          <div class="form-group col">
            <label for="seqCol">Sequence Column</label>
            <select class="form-control" id="seqCol" disabled></select>
          </div>
        </div>
        <div class="row" id="downloads">
          <div class="col-12">
            <div class="mb-2">Downloads</div>
          </div>
          <div class="col-12">
            <div class="row">
              <div class="col">
                <button type="button" id="downloadFASTA" class="btn btn-primary w-100">Download FASTA</button>
              </div>
              <div class="col">
                <button type="button" id="downloadMEGA" class="btn btn-primary w-100">Download MEGA</button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.3/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script>
      var data = [];
      $(function(){
        $('#customFile').on('change', function(e){
          let file = e.target.files[0];
          $('label[for="customFile"]').text(file.name);
          Papa.parse(file, {
            header: true,
            complete: function(result){
              $('#downloads').slideDown();
              data = result.data;
              $('select').html(result.meta.fields.map(f => `<option>${f}</option>`).join('')).prop('disabled', false);
            }
          });
        });

        $('#downloadFASTA').on('click', function(){
          var name = $('#customFile').get(0).files[0].name.split('.').slice(0,-1).join('.');
          var fasta = '';
          var seqCol = $('#seqCol').val();
          var idCol = $('#idCol').val();
          data.forEach(row => fasta += `>${row[idCol]}\n${row[seqCol]}\n`);
          var blob = new Blob([fasta], {type: 'text/plain;charset=utf-8'});
          saveAs(blob, name + '.fasta');
        });

        $('#downloadMEGA').on('click', function(){
          var name = $('#customFile').get(0).files[0].name.split('.').slice(0,-1).join('.');
          var seqCol = $('#seqCol').val();
          var idCol = $('#idCol').val();
          var mega = '#mega\nTITLE: '+name+'\n';
          data.forEach(row => mega += `#${row[idCol]}\n${row[seqCol]}\n`);
          var blob = new Blob([mega], {type: 'text/plain;charset=utf-8'});
          saveAs(blob, name + '.mega');
        });
      });
    </script>
  </body>
</html>
